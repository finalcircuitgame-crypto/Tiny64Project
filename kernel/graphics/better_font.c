#include "../include/kernel.h"
#include "../include/string.h"

// Better Windows XP-style font rendering
// Anti-aliased bitmap font with more characters

// Font metrics
#define FONT_WIDTH 8
#define FONT_HEIGHT 16
#define FONT_CHARS 256

// Font bitmap data (8x16 pixels per character, 1 bit per pixel)
// This is a better quality font that looks more like Windows XP fonts
static const uint8_t font_bitmap[FONT_CHARS][FONT_HEIGHT] = {
    // Space (32)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // ! (33)
    {0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00},

    // " (34)
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // # (35)
    {0x00, 0x24, 0x24, 0x7E, 0x24, 0x24, 0x7E, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // $ (36)
    {0x00, 0x18, 0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // % (37)
    {0x00, 0x62, 0x66, 0x0C, 0x18, 0x30, 0x62, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // & (38)
    {0x00, 0x3C, 0x66, 0x66, 0x3C, 0x38, 0x6C, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // ' (39)
    {0x00, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // ( (40)
    {0x00, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // ) (41)
    {0x00, 0x60, 0x30, 0x18, 0x18, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // * (42)
    {0x00, 0x00, 0x42, 0x24, 0x18, 0x7E, 0x18, 0x24, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // + (43)
    {0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // , (44)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},

    // - (45)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // . (46)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // / (47)
    {0x00, 0x06, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x30, 0x30, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 0 (48)
    {0x00, 0x3C, 0x66, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 1 (49)
    {0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 2 (50)
    {0x00, 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 3 (51)
    {0x00, 0x3C, 0x66, 0x06, 0x1C, 0x06, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 4 (52)
    {0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0x4C, 0x7E, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 5 (53)
    {0x00, 0x7E, 0x60, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 6 (54)
    {0x00, 0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 7 (55)
    {0x00, 0x7E, 0x06, 0x0C, 0x18, 0x18, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 8 (56)
    {0x00, 0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 9 (57)
    {0x00, 0x3C, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // : (58)
    {0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // ; (59)
    {0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // < (60)
    {0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // = (61)
    {0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // > (62)
    {0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // ? (63)
    {0x00, 0x3C, 0x66, 0x06, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // @ (64)
    {0x00, 0x3C, 0x66, 0x6E, 0x6E, 0x6E, 0x60, 0x62, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // A (65)
    {0x00, 0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // B (66)
    {0x00, 0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // C (67)
    {0x00, 0x3C, 0x66, 0x60, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // D (68)
    {0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // E (69)
    {0x00, 0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // F (70)
    {0x00, 0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // G (71)
    {0x00, 0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // H (72)
    {0x00, 0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // I (73)
    {0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // J (74)
    {0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x4C, 0x4C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // K (75)
    {0x00, 0x66, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // L (76)
    {0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // M (77)
    {0x00, 0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // N (78)
    {0x00, 0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // O (79)
    {0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // P (80)
    {0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // Q (81)
    {0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x6E, 0x66, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // R (82)
    {0x00, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // S (83)
    {0x00, 0x3C, 0x66, 0x60, 0x3C, 0x06, 0x06, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // T (84)
    {0x00, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // U (85)
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // V (86)
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // W (87)
    {0x00, 0x63, 0x63, 0x63, 0x6B, 0x7F, 0x7F, 0x77, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // X (88)
    {0x00, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // Y (89)
    {0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // Z (90)
    {0x00, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // Fill the rest with space pattern
    // ... (91-255 would be filled with appropriate characters)
};

// Windows XP-style font rendering with better quality
void draw_char_better(BootInfo *info, char c, int x, int y, uint32_t fg_color, uint32_t bg_color, int scale) {
    if (c < 0 || c >= FONT_CHARS) c = '?';
    if (c == '?' && (c < 0 || c >= FONT_CHARS)) c = ' ';

    uint32_t *fb = info->backbuffer ? info->backbuffer : info->framebuffer;
    uint32_t pitch = info->pitch;

    for (int row = 0; row < FONT_HEIGHT; row++) {
        uint8_t row_data = font_bitmap[(uint8_t)c][row];

        for (int col = 0; col < FONT_WIDTH; col++) {
            int bit = (row_data >> (7 - col)) & 1;

            for (int sy = 0; sy < scale; sy++) {
                for (int sx = 0; sx < scale; sx++) {
                    int px = x + col * scale + sx;
                    int py = y + row * scale + sy;

                    if (px >= 0 && px < (int)info->width && py >= 0 && py < (int)info->height) {
                        uint32_t index = py * pitch + px;

                        if (bit) {
                            // Anti-aliased edge pixels for better quality
                            if (scale > 1) {
                                // For scaled fonts, create subtle anti-aliasing
                                if ((sx == 0 || sx == scale-1 || sy == 0 || sy == scale-1) && scale > 2) {
                                    // Edge pixels: blend with background
                                    uint32_t existing = fb[index];
                                    uint8_t r = ((existing >> 16) & 0xFF) * 3 / 4 + ((fg_color >> 16) & 0xFF) / 4;
                                    uint8_t g = ((existing >> 8) & 0xFF) * 3 / 4 + ((fg_color >> 8) & 0xFF) / 4;
                                    uint8_t b = (existing & 0xFF) * 3 / 4 + (fg_color & 0xFF) / 4;
                                    fb[index] = (r << 16) | (g << 8) | b;
                                } else {
                                    fb[index] = fg_color;
                                }
                            } else {
                                fb[index] = fg_color;
                            }
                        } else if (bg_color != 0xFFFFFFFF) { // Only draw background if not transparent
                            fb[index] = bg_color;
                        }
                    }
                }
            }
        }
    }
}

// Enhanced kprint with better font
void kprint_better(BootInfo *info, const char *str, int x, int y, uint32_t fg_color, uint32_t bg_color, int scale) {
    if (!str) return;

    int current_x = x;
    while (*str) {
        if (*str == '\n') {
            current_x = x;
            y += FONT_HEIGHT * scale + 2;
        } else {
            draw_char_better(info, *str, current_x, y, fg_color, bg_color, scale);
            current_x += FONT_WIDTH * scale + 1; // Small character spacing
        }
        str++;
    }
}

// Measure text width for centering
int measure_text_width(const char *str, int scale) {
    if (!str) return 0;
    int width = 0;
    while (*str) {
        if (*str != '\n') {
            width += FONT_WIDTH * scale + 1;
        }
        str++;
    }
    return width > 0 ? width - 1 : 0; // Remove last spacing
}
